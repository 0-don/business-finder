services:
  business-finder-view:
    container_name: business-finder-view
    depends_on:
      - business-finder-db
    build:
      context: ./
      dockerfile: Dockerfile
      target: business-finder-view
    restart: always
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
      - GOOGLE_PLACES_API=${GOOGLE_PLACES_API}
      - GOOGLE_MAPS_JAVASCRIPT_API=${GOOGLE_MAPS_JAVASCRIPT_API}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.business-finder-view.rule=Host(`business-finder.coding.global`)"
      - "traefik.http.routers.business-finder-view.entrypoints=websecure"
      - "traefik.http.routers.business-finder-view.tls.certresolver=letsencrypt"
      - "traefik.http.services.business-finder-view.loadbalancer.server.port=3000"
  business-finder:
    container_name: business-finder
    depends_on:
      - business-finder-db
    build:
      context: ./
      dockerfile: Dockerfile
      target: business-finder
    restart: always
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
      - GOOGLE_PLACES_API=${GOOGLE_PLACES_API}
      - GOOGLE_MAPS_JAVASCRIPT_API=${GOOGLE_MAPS_JAVASCRIPT_API}
  business-finder-db:
    container_name: business-finder-db
    image: postgis/postgis:latest
    restart: always
    ports:
      - 5437:5432
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres:/var/lib/postgresql/data
    shm_size: 8g
    deploy:
      resources:
        limits:
          memory: 24g
        reservations:
          memory: 16g
    command: |
      postgres
      -c max_connections=200
      -c shared_buffers=8GB
      -c effective_cache_size=24GB
      -c work_mem=512MB
      -c maintenance_work_mem=2GB
      -c max_worker_processes=16
      -c max_parallel_workers=16
      -c max_parallel_workers_per_gather=8
      -c max_parallel_maintenance_workers=8
      -c parallel_setup_cost=10
      -c parallel_tuple_cost=0.001
      -c random_page_cost=0.5
      -c seq_page_cost=0.5
      -c effective_io_concurrency=1000
      -c checkpoint_completion_target=0.95
      -c wal_buffers=512MB
      -c default_statistics_target=1000
      -c temp_buffers=256MB
      -c max_wal_size=8GB
      -c min_wal_size=2GB
      -c autovacuum_work_mem=2GB
      -c autovacuum_max_workers=6
      -c max_wal_senders=0
      -c max_replication_slots=0
      -c wal_level=replica
      -c synchronous_commit=off
      -c fsync=off
      -c full_page_writes=off
      -c huge_pages=try
      -c temp_file_limit=10GB
      -c log_min_duration_statement=10000

volumes:
  postgres:
    driver: local
networks:
  proxy:
    external: false
    name: proxy
